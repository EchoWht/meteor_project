var require = meteorInstall({"lib":{"comments.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                             //
// lib/comments.js                                                                                             //
//                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                               //
/**                                                                                                            //
 * Created by Administrator on 2016-06-12.                                                                     //
 */                                                                                                            //
Comments = new Mongo.Collection('comments');                                                                   // 4
Meteor.methods({                                                                                               // 5
    commentInsert: function () {                                                                               // 6
        function commentInsert(commentAttributes) {                                                            // 6
            check(this.userId, String);                                                                        // 7
            check(commentAttributes, {                                                                         // 8
                postId: String,                                                                                // 9
                body: String                                                                                   // 10
            });                                                                                                //
            var user = Meteor.user();                                                                          // 12
            var post = Posts.findOne(commentAttributes.postId);                                                // 13
            if (!post) throw new Meteor.Error('invalid-comment', 'You must comment on a post');                // 14
            comment = _.extend(commentAttributes, {                                                            // 16
                userId: user._id,                                                                              // 17
                author: user.username,                                                                         // 18
                submitted: new Date()                                                                          // 19
            });                                                                                                //
            // 更新帖子的评论数                                                                                        //
            Posts.update(comment.postId, { $inc: { commentsCount: 1 } });                                      // 6
            // return Comments.insert(comment);                                                                //
            // create the comment, save the id                                                                 //
            comment._id = Comments.insert(comment);                                                            // 6
            // now create a notification, informing the user that there's been a comment                       //
            createCommentNotification(comment);                                                                // 6
            return comment._id;                                                                                // 28
        }                                                                                                      //
                                                                                                               //
        return commentInsert;                                                                                  //
    }()                                                                                                        //
});                                                                                                            //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"notifications.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                             //
// lib/notifications.js                                                                                        //
//                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                               //
/**                                                                                                            //
 * Created by Administrator on 2016-06-12.                                                                     //
 */                                                                                                            //
Notifications = new Mongo.Collection('notifications');                                                         // 4
                                                                                                               //
Notifications.allow({                                                                                          // 6
    update: function () {                                                                                      // 7
        function update(userId, doc, fieldNames) {                                                             // 7
            return ownsDocument(userId, doc) && fieldNames.length === 1 && fieldNames[0] === 'read';           // 8
        }                                                                                                      //
                                                                                                               //
        return update;                                                                                         //
    }()                                                                                                        //
});                                                                                                            //
                                                                                                               //
createCommentNotification = function createCommentNotification(comment) {                                      // 13
    var post = Posts.findOne(comment.postId);                                                                  // 14
    if (comment.userId !== post.userId) {                                                                      // 15
        Notifications.insert({                                                                                 // 16
            userId: post.userId,                                                                               // 17
            postId: post._id,                                                                                  // 18
            commentId: comment._id,                                                                            // 19
            commenterName: comment.author,                                                                     // 20
            read: false                                                                                        // 21
        });                                                                                                    //
    }                                                                                                          //
};                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"permissions.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                             //
// lib/permissions.js                                                                                          //
//                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                               //
/**                                                                                                            //
 * Created by Administrator on 2016-06-12.                                                                     //
 */                                                                                                            //
ownsDocument = function ownsDocument(userId, doc) {                                                            // 4
  return doc && doc.userId === userId;                                                                         // 5
};                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"router.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                             //
// lib/router.js                                                                                               //
//                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                               //
Router.configure({                                                                                             // 1
  layoutTemplate: 'layout',                                                                                    // 2
  loadingTemplate: 'loading',                                                                                  // 3
  notFoundTemplate: 'notFound',                                                                                // 4
  waitOn: function () {                                                                                        // 5
    function waitOn() {                                                                                        // 5
      return [Meteor.subscribe('notifications')];                                                              // 6
    }                                                                                                          //
                                                                                                               //
    return waitOn;                                                                                             //
  }()                                                                                                          //
});                                                                                                            //
PostsListController = RouteController.extend({                                                                 // 9
  template: 'postsList',                                                                                       // 10
  increment: 5,                                                                                                // 11
  postsLimit: function () {                                                                                    // 12
    function postsLimit() {                                                                                    // 12
      return parseInt(this.params.postsLimit) || this.increment;                                               // 13
    }                                                                                                          //
                                                                                                               //
    return postsLimit;                                                                                         //
  }(),                                                                                                         //
  findOptions: function () {                                                                                   // 15
    function findOptions() {                                                                                   // 15
      return { sort: this.sort, limit: this.postsLimit() };                                                    // 16
    }                                                                                                          //
                                                                                                               //
    return findOptions;                                                                                        //
  }(),                                                                                                         //
  subscriptions: function () {                                                                                 // 18
    function subscriptions() {                                                                                 // 18
      this.postsSub = Meteor.subscribe('posts', this.findOptions());                                           // 19
    }                                                                                                          //
                                                                                                               //
    return subscriptions;                                                                                      //
  }(),                                                                                                         //
  posts: function () {                                                                                         // 21
    function posts() {                                                                                         // 21
      return Posts.find({}, this.findOptions());                                                               // 22
    }                                                                                                          //
                                                                                                               //
    return posts;                                                                                              //
  }(),                                                                                                         //
  data: function () {                                                                                          // 24
    function data() {                                                                                          // 24
      var hasMore = this.posts().count() === this.postsLimit();                                                // 25
      return {                                                                                                 // 26
        posts: this.posts(),                                                                                   // 27
        ready: this.postsSub.ready,                                                                            // 28
        nextPath: hasMore ? this.nextPath() : null                                                             // 29
      };                                                                                                       //
    }                                                                                                          //
                                                                                                               //
    return data;                                                                                               //
  }()                                                                                                          //
});                                                                                                            //
NewPostsController = PostsListController.extend({                                                              // 33
  sort: { submitted: -1, _id: -1 },                                                                            // 34
  nextPath: function () {                                                                                      // 35
    function nextPath() {                                                                                      // 35
      return Router.routes.newPosts.path({ postsLimit: this.postsLimit() + this.increment });                  // 36
    }                                                                                                          //
                                                                                                               //
    return nextPath;                                                                                           //
  }()                                                                                                          //
});                                                                                                            //
BestPostsController = PostsListController.extend({                                                             // 39
  sort: { votes: -1, submitted: -1, _id: -1 },                                                                 // 40
  nextPath: function () {                                                                                      // 41
    function nextPath() {                                                                                      // 41
      return Router.routes.bestPosts.path({ postsLimit: this.postsLimit() + this.increment });                 // 42
    }                                                                                                          //
                                                                                                               //
    return nextPath;                                                                                           //
  }()                                                                                                          //
});                                                                                                            //
Router.route('/', {                                                                                            // 45
  name: 'home',                                                                                                // 46
  controller: NewPostsController                                                                               // 47
});                                                                                                            //
Router.route('/new/:postsLimit?', { name: 'newPosts' });                                                       // 49
Router.route('/best/:postsLimit?', { name: 'bestPosts' });                                                     // 50
Router.route('/posts/:_id', {                                                                                  // 51
  name: 'postPage',                                                                                            // 52
  waitOn: function () {                                                                                        // 53
    function waitOn() {                                                                                        // 53
      return [Meteor.subscribe('singlePost', this.params._id), Meteor.subscribe('comments', this.params._id)];
    }                                                                                                          //
                                                                                                               //
    return waitOn;                                                                                             //
  }(),                                                                                                         //
  data: function () {                                                                                          // 59
    function data() {                                                                                          // 59
      return Posts.findOne(this.params._id);                                                                   // 59
    }                                                                                                          //
                                                                                                               //
    return data;                                                                                               //
  }()                                                                                                          //
});                                                                                                            //
                                                                                                               //
Router.route('/posts/:_id/edit', {                                                                             // 62
  name: 'postEdit',                                                                                            // 63
  waitOn: function () {                                                                                        // 64
    function waitOn() {                                                                                        // 64
      return Meteor.subscribe('singlePost', this.params._id);                                                  // 65
    }                                                                                                          //
                                                                                                               //
    return waitOn;                                                                                             //
  }(),                                                                                                         //
  data: function () {                                                                                          // 67
    function data() {                                                                                          // 67
      return Posts.findOne(this.params._id);                                                                   // 67
    }                                                                                                          //
                                                                                                               //
    return data;                                                                                               //
  }()                                                                                                          //
});                                                                                                            //
                                                                                                               //
Router.route('/submit', { name: 'postSubmit' });                                                               // 70
                                                                                                               //
Router.route('/:postsLimit?', {                                                                                // 72
  name: 'postsList'                                                                                            // 73
});                                                                                                            //
                                                                                                               //
var requireLogin = function requireLogin() {                                                                   // 76
  if (!Meteor.user()) {                                                                                        // 77
    if (Meteor.loggingIn()) {                                                                                  // 78
      this.render(this.loadingTemplate);                                                                       // 79
    } else {                                                                                                   //
      this.render('accessDenied');                                                                             // 81
    }                                                                                                          //
  } else {                                                                                                     //
    this.next();                                                                                               // 84
  }                                                                                                            //
};                                                                                                             //
                                                                                                               //
Router.onBeforeAction('dataNotFound', { only: 'postPage' });                                                   // 88
Router.onBeforeAction(requireLogin, { only: 'postSubmit' });                                                   // 89
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"collections":{"posts.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                             //
// collections/posts.js                                                                                        //
//                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                               //
Posts = new Mongo.Collection('posts');                                                                         // 1
validatePost = function validatePost(post) {                                                                   // 2
    var errors = {};                                                                                           // 3
    if (!post.title) errors.title = "请填写标题";                                                                   // 4
    if (!post.url) errors.url = "请填写 URL";                                                                     // 6
    return errors;                                                                                             // 8
};                                                                                                             //
/*允许用户编辑*/                                                                                                     //
Posts.allow({                                                                                                  // 11
    update: function () {                                                                                      // 12
        function update(userId, post) {                                                                        // 12
            return ownsDocument(userId, post);                                                                 // 12
        }                                                                                                      //
                                                                                                               //
        return update;                                                                                         //
    }(),                                                                                                       //
    remove: function () {                                                                                      // 13
        function remove(userId, post) {                                                                        // 13
            return ownsDocument(userId, post);                                                                 // 13
        }                                                                                                      //
                                                                                                               //
        return remove;                                                                                         //
    }()                                                                                                        //
});                                                                                                            //
/*限制用户编辑的字段*/                                                                                                  //
Posts.deny({                                                                                                   // 16
    update: function () {                                                                                      // 17
        function update(userId, post, fieldNames) {                                                            // 17
            // 只能更改如下两个字段：                                                                                     //
            return _.without(fieldNames, 'url', 'title').length > 0;                                           // 19
        }                                                                                                      //
                                                                                                               //
        return update;                                                                                         //
    }()                                                                                                        //
});                                                                                                            //
/*修改*/                                                                                                         //
Posts.deny({                                                                                                   // 23
    update: function () {                                                                                      // 24
        function update(userId, post, fieldNames, modifier) {                                                  // 24
            var errors = validatePost(modifier.$set);                                                          // 25
            return errors.title || errors.url;                                                                 // 26
        }                                                                                                      //
                                                                                                               //
        return update;                                                                                         //
    }()                                                                                                        //
});                                                                                                            //
Meteor.methods({                                                                                               // 29
    postInsert: function () {                                                                                  // 30
        function postInsert(postAttributes) {                                                                  // 30
            check(Meteor.userId(), String);                                                                    // 31
            check(postAttributes, {                                                                            // 32
                title: String,                                                                                 // 33
                url: String                                                                                    // 34
            });                                                                                                //
            /*防止用户通过控制台来插入数据*/                                                                                 //
            var errors = validatePost(postAttributes);                                                         // 30
            if (errors.title || errors.url) throw new Meteor.Error('invalid-post', "你必须为你的帖子填写标题和 URL");       // 38
            /*防止重复*/                                                                                           //
            var postWithSameLink = Posts.findOne({ url: postAttributes.url });                                 // 30
            if (postWithSameLink) {                                                                            // 42
                return {                                                                                       // 43
                    postExists: true,                                                                          // 44
                    _id: postWithSameLink._id                                                                  // 45
                };                                                                                             //
            }                                                                                                  //
                                                                                                               //
            var user = Meteor.user();                                                                          // 49
            var post = _.extend(postAttributes, {                                                              // 50
                userId: user._id,                                                                              // 51
                author: user.username,                                                                         // 52
                submitted: new Date(),                                                                         // 53
                commentsCount: 0,                                                                              // 54
                upvoters: [],                                                                                  // 55
                votes: 0                                                                                       // 56
            });                                                                                                //
            var postId = Posts.insert(post);                                                                   // 58
            return {                                                                                           // 59
                _id: postId                                                                                    // 60
            };                                                                                                 //
        }                                                                                                      //
                                                                                                               //
        return postInsert;                                                                                     //
    }(),                                                                                                       //
    upvote: function () {                                                                                      // 64
        function upvote(postId) {                                                                              // 64
            check(this.userId, String);                                                                        // 65
            check(postId, String);                                                                             // 66
                                                                                                               //
            var affected = Posts.update({                                                                      // 68
                _id: postId,                                                                                   // 69
                upvoters: { $ne: this.userId }                                                                 // 70
            }, {                                                                                               //
                $addToSet: { upvoters: this.userId },                                                          // 72
                $inc: { votes: 1 }                                                                             // 73
            });                                                                                                //
            if (!affected) throw new Meteor.Error('invalid', "You weren't able to upvote that post");          // 75
        }                                                                                                      //
                                                                                                               //
        return upvote;                                                                                         //
    }()                                                                                                        //
});                                                                                                            //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"server":{"fixtures.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                             //
// server/fixtures.js                                                                                          //
//                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                               //
if (Posts.find().count() === 0) {                                                                              // 1
  var now = new Date().getTime();                                                                              // 2
                                                                                                               //
  // create two users                                                                                          //
  var tomId = Meteor.users.insert({                                                                            // 1
    profile: { name: 'Tom Coleman' }                                                                           // 6
  });                                                                                                          //
  var tom = Meteor.users.findOne(tomId);                                                                       // 8
  var sachaId = Meteor.users.insert({                                                                          // 9
    profile: { name: 'Sacha Greif' }                                                                           // 10
  });                                                                                                          //
  var sacha = Meteor.users.findOne(sachaId);                                                                   // 12
                                                                                                               //
  var telescopeId = Posts.insert({                                                                             // 14
    title: 'Introducing Telescope',                                                                            // 15
    userId: sacha._id,                                                                                         // 16
    author: sacha.profile.name,                                                                                // 17
    url: 'http://sachagreif.com/introducing-telescope/',                                                       // 18
    submitted: new Date(now - 7 * 3600 * 1000),                                                                // 19
    commentsCount: 2,                                                                                          // 20
    upvoters: [],                                                                                              // 21
    votes: 0                                                                                                   // 22
  });                                                                                                          //
                                                                                                               //
  Comments.insert({                                                                                            // 25
    postId: telescopeId,                                                                                       // 26
    userId: tom._id,                                                                                           // 27
    author: tom.profile.name,                                                                                  // 28
    submitted: new Date(now - 5 * 3600 * 1000),                                                                // 29
    body: 'Interesting project Sacha, can I get involved?'                                                     // 30
  });                                                                                                          //
                                                                                                               //
  Comments.insert({                                                                                            // 33
    postId: telescopeId,                                                                                       // 34
    userId: sacha._id,                                                                                         // 35
    author: sacha.profile.name,                                                                                // 36
    submitted: new Date(now - 3 * 3600 * 1000),                                                                // 37
    body: 'You sure can Tom!'                                                                                  // 38
  });                                                                                                          //
                                                                                                               //
  Posts.insert({                                                                                               // 41
    title: 'Meteor',                                                                                           // 42
    userId: tom._id,                                                                                           // 43
    author: tom.profile.name,                                                                                  // 44
    url: 'http://meteor.com',                                                                                  // 45
    submitted: new Date(now - 10 * 3600 * 1000),                                                               // 46
    commentsCount: 0,                                                                                          // 47
    upvoters: [],                                                                                              // 48
    votes: 0                                                                                                   // 49
  });                                                                                                          //
                                                                                                               //
  Posts.insert({                                                                                               // 52
    title: 'The Meteor Book',                                                                                  // 53
    userId: tom._id,                                                                                           // 54
    author: tom.profile.name,                                                                                  // 55
    url: 'http://themeteorbook.com',                                                                           // 56
    submitted: new Date(now - 12 * 3600 * 1000),                                                               // 57
    commentsCount: 0,                                                                                          // 58
    upvoters: [],                                                                                              // 59
    votes: 0                                                                                                   // 60
  });                                                                                                          //
                                                                                                               //
  for (var i = 0; i < 10; i++) {                                                                               // 63
    Posts.insert({                                                                                             // 64
      title: 'Test post #' + i,                                                                                // 65
      author: sacha.profile.name,                                                                              // 66
      userId: sacha._id,                                                                                       // 67
      url: 'http://google.com/?q=test-' + i,                                                                   // 68
      submitted: new Date(now - i * 3600 * 1000 + 1),                                                          // 69
      commentsCount: 0,                                                                                        // 70
      upvoters: [],                                                                                            // 71
      votes: 0                                                                                                 // 72
    });                                                                                                        //
  }                                                                                                            //
}                                                                                                              //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"publications.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                             //
// server/publications.js                                                                                      //
//                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                               //
Meteor.publish('posts', function (options) {                                                                   // 1
  check(options, {                                                                                             // 2
    sort: Object,                                                                                              // 3
    limit: Number                                                                                              // 4
  });                                                                                                          //
  return Posts.find({}, options);                                                                              // 6
});                                                                                                            //
Meteor.publish('singlePost', function (id) {                                                                   // 8
  check(id, String);                                                                                           // 9
  return Posts.find(id);                                                                                       // 10
});                                                                                                            //
Meteor.publish('comments', function (postId) {                                                                 // 12
  check(postId, String);                                                                                       // 13
  return Comments.find({ postId: postId });                                                                    // 14
});                                                                                                            //
                                                                                                               //
Meteor.publish('notifications', function () {                                                                  // 17
  return Notifications.find({ userId: this.userId });                                                          // 18
});                                                                                                            //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"main.js":["meteor/meteor",function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                             //
// server/main.js                                                                                              //
//                                                                                                             //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                               //
var _meteor = require('meteor/meteor');                                                                        // 1
                                                                                                               //
//Meteor.subscribe('posts');                                                                                   //
_meteor.Meteor.startup(function () {                                                                           // 3
  // code to run on server at startup                                                                          //
});                                                                                                            //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}]}},{"extensions":[".js",".json"]});
require("./lib/comments.js");
require("./lib/notifications.js");
require("./lib/permissions.js");
require("./lib/router.js");
require("./collections/posts.js");
require("./server/fixtures.js");
require("./server/publications.js");
require("./server/main.js");
//# sourceMappingURL=app.js.map
